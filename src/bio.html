<!DOCTYPE html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SN - Bio</title>
    <link rel="icon" type="image/x-icon" href="resources/icons/favicon.ico">
    <script>
        // Set theme immediately to prevent FOUC (Flash of Unstyled Content)
        (function() {
            try {
                const savedTheme = localStorage.getItem("theme") || "light";
                document.documentElement.setAttribute("data-theme", savedTheme);
            } catch(e) {
                // Fallback if localStorage is blocked
                document.documentElement.setAttribute("data-theme", "light");
            }
        })();
    </script>
    <link rel="stylesheet" href="styles.css" />
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css"
    />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
      // Configure marked to open links in a new tab
      const renderer = new marked.Renderer();
      renderer.link = function (href, title, text) {

        // Handle case where href might be an object (older marked versions)
        let linkHref = href;
        let linkText = text;
        let linkTitle = title;

        if (typeof href === 'object' && href !== null) {
          // Older marked versions pass a token object
          linkHref = href.href || '';
          linkText = href.text || text || '';
          linkTitle = href.title || title || '';
        }

        // Sanitize href to prevent XSS (basic escaping)
        linkHref = linkHref.replace(/"/g, '&quot;');
        linkText = linkText || 'Link'; // Fallback if text is undefined

        return `<a href="${linkHref}" target="_blank" rel="noopener noreferrer" ${linkTitle ? `title="${linkTitle}"` : ''}>${linkText}</a>`;
      };

      marked.setOptions({
        renderer: renderer,
        highlight: function (code, lang) {
          const hljs = window.hljs;
          return hljs.highlight(code, { language: lang }).value;
        },
        langPrefix: 'hljs language-',
      });

      document.addEventListener("DOMContentLoaded", () => {
        hljs.highlightAll();
      });
    </script>
</head>
<body>
    <button id="backToTop" title="Go to top">â¬†</button>    <div id="banner-placeholder"></div>

    <section class="content-container">
      <div class="content-text" id="contentText">Loading bio...</div>
    </section>

    <script src="script.js"></script>
    <script>
      // Position theme toggle button below banner
      function adjustThemeTogglePosition() {
        requestAnimationFrame(() => {
          const banner = document.getElementById("banner-placeholder");
          const themeToggle = document.getElementById("themeToggle");
          if (banner && themeToggle) {
            const bannerRect = banner.getBoundingClientRect();
            const bannerBottom = Math.max(0, bannerRect.bottom);
            themeToggle.style.top = `${bannerBottom + 10}px`;
            themeToggle.classList.add("positioned");
          }
        });
      }

      // Load banner first
      fetch("banner.html")
        .then(response => response.text())
        .then(html => {
          document.getElementById("banner-placeholder").innerHTML = html;
          if (typeof initDropdownToggle === "function") {
            initDropdownToggle();
          }
          // Position theme toggle after banner loads
          adjustThemeTogglePosition();
        })
        .catch(error => console.error("Failed to load banner:", error));

      // Update position on scroll
      window.addEventListener("scroll", adjustThemeTogglePosition);
      window.addEventListener("touchmove", adjustThemeTogglePosition, { passive: true });
      window.addEventListener("load", adjustThemeTogglePosition);

      // Load bio content
      document.addEventListener("DOMContentLoaded", () => {
        fetch("bio/bio.md")
          .then((response) => response.text())
          .then((data) => {
            document.getElementById("contentText").innerHTML = marked.parse(data);
            hljs.highlightAll();
            
            // Initialize tooltips after content loads
            setTimeout(() => {
              if (window.tooltipManager) {
                fetch("bio/res/tooltips.json")
                  .then(response => response.json())
                  .then(data => {
                    Object.entries(data).forEach(([id, tooltipData]) => {
                      if (tooltipData.media && !tooltipData.media.startsWith('http')) {
                        tooltipData.media = `bio/res/${tooltipData.media}`;
                      }
                      window.tooltipManager.tooltipData.set(id, tooltipData);
                    });
                    window.tooltipManager.initializeTooltips();
                  })
                  .catch(error => console.warn('No tooltips available for bio page'));
              }
            }, 100);
          })
          .catch((error) => {
            console.error("Error loading bio:", error);
            document.getElementById("contentText").innerHTML = "Failed to load bio.";
          });
      });
    </script>
  </body>
</html>