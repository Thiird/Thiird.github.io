<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SN - Poems</title>
    <link rel="stylesheet" href="styles.css" />
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  </head>
  <body>
    <div id="banner-placeholder"></div>

    <!-- Mobile toggle (visible on small screens) -->
    <button id="sidebarFloatingToggle" class="mobile-sidebar-toggle" aria-label="Open menu">☰</button>

    <div class="content-scale-wrapper">
      <section class="poem-container">
        <aside class="poem-list" id="poemList">
          <div class="poem-list-header">
            <button id="toggleSidebar" class="toggle-btn">⏴</button>
            <input
              type="text"
              id="poemSearch"
              placeholder="Search"
              class="poem-search"
            />
          </div>
          <ul id="poemListItems">
            <!-- dynamically filled -->
          </ul>
        </aside>

        <div class="poem-content">
          <!-- Audio Player -->
          <div class="audio-player" style="display: none" id="audioPlayer">
            <div class="player-controls">
              <button id="playPause" class="player-btn">▶</button>
              <span id="currentTime">0:00</span>
              <div class="progress-container">
                <div id="progressBar"></div>
              </div>
              <span id="duration">0:00</span>
            </div>
            <audio id="audioElement">
              <source src="" type="audio/mpeg" />
            </audio>
          </div>

          <div class="poem-text" id="poemText">Loading poem...</div>
        </div>
      </section>
    </div>

    <script>
      // Insert the banner and initialize dropdown
      fetch("banner.html")
        .then((response) => response.text())
        .then((data) => {
          const banner = document.getElementById("banner-placeholder");
          banner.innerHTML = data;

          // Adjust poem list position
          adjustSidebarHeight();

          // Initialize dropdown toggle
          if (typeof initDropdownToggle === "function") {
            initDropdownToggle();
          }
        })
        .catch((error) => console.error("Error loading banner:", error));

      // Adjust sidebar height dynamically and pad content below banner
      function adjustSidebarHeight() {
        // use rAF for smoother updates and to cover rapid scroll/touch events
        requestAnimationFrame(() => {
          const banner = document.getElementById("banner-placeholder");
          const poemList = document.getElementById("poemList");
          const contentWrapper = document.querySelector(".content-scale-wrapper");
          const mobileToggle = document.getElementById("sidebarFloatingToggle");
          if (banner && poemList) {
            const bannerRect = banner.getBoundingClientRect();
            const bannerBottom = bannerRect.bottom;
            const topOffset = Math.max(0, bannerBottom);
            poemList.style.top = `${topOffset}px`;
            poemList.style.height = `calc(100vh - ${topOffset}px)`;
            // ensure main content starts below the banner to avoid overlap
            if (contentWrapper) {
              contentWrapper.style.paddingTop = `${topOffset}px`;
            }
            // position mobile toggle under banner only while banner is visible,
            // otherwise keep it at fixed corner (12px)
            if (mobileToggle) {
              const gap = 8; // px
              if (bannerBottom > 0) {
                mobileToggle.style.top = `${bannerBottom + gap}px`;
              } else {
                mobileToggle.style.top = `12px`;
              }
            }
          } else {
            // fallback: reset mobile toggle position
            if (mobileToggle) mobileToggle.style.top = `12px`;
            if (contentWrapper) contentWrapper.style.paddingTop = ``;
          }
        });
      }

      // Responsive toggle for poem list
      const poemToggle = document.getElementById("toggleSidebar");
      const floatingToggle = document.getElementById("sidebarFloatingToggle");

      function setPoemSidebarInitial() {
        const poemList = document.getElementById("poemList");
        // reset any leftover classes
        document.body.classList.remove("no-scroll");
        if (floatingToggle) floatingToggle.classList.remove("hidden");

        if (window.innerWidth > 800) {
          poemList.classList.remove("collapsed", "show");
        } else {
          poemList.classList.remove("collapsed");
          poemList.classList.remove("show");
        }
      }

      poemToggle.addEventListener("click", () => {
        const poemList = document.getElementById("poemList");
        const isMobile = window.innerWidth <= 800;
        if (isMobile) {
          const isOpen = poemList.classList.toggle("show");
          document.body.classList.toggle("no-scroll", isOpen);
          document.documentElement.classList.toggle("no-scroll", isOpen);
          if (floatingToggle) floatingToggle.classList.toggle("hidden", isOpen);
          poemList.classList.remove("collapsed");
        } else {
          poemList.classList.toggle("collapsed");
          poemList.classList.remove("show");
          document.body.classList.remove("no-scroll");
          document.documentElement.classList.remove("no-scroll");
          if (floatingToggle) floatingToggle.classList.remove("hidden");
        }
      });

      // NEW: mobile toggle button handler
      if (floatingToggle) {
        floatingToggle.addEventListener("click", (e) => {
          e.stopPropagation();
          const poemList = document.getElementById("poemList");
          const isOpen = poemList.classList.toggle("show");
          document.body.classList.toggle("no-scroll", isOpen);
          document.documentElement.classList.toggle("no-scroll", isOpen);
          floatingToggle.classList.toggle("hidden", isOpen);
        });
      }

      // Close mobile poem sidebar when clicking outside (ignore mobile toggle)
      document.addEventListener("click", (e) => {
        const poemList = document.getElementById("poemList");
        if (!poemList) return;
        if (window.innerWidth <= 800 && poemList.classList.contains("show")) {
          if (!e.target.closest(".poem-list") && !e.target.closest("#toggleSidebar") && !e.target.closest("#sidebarFloatingToggle")) {
            poemList.classList.remove("show");
            document.body.classList.remove("no-scroll");
            document.documentElement.classList.remove("no-scroll");
            if (floatingToggle) floatingToggle.classList.remove("hidden");
          }
        }
      });

      // Ensure correct initial state on load and resize
      window.addEventListener("load", () => {
        setPoemSidebarInitial();
        adjustSidebarHeight();
      });
      window.addEventListener("resize", () => {
        setPoemSidebarInitial();
        adjustSidebarHeight();
      });
      // Follow banner on scroll so mobile toggle stays under banner
      window.addEventListener("scroll", adjustSidebarHeight);
      // NEW: also update during touch (rubber-band / touchmove) to follow banner on mobile gestures
      window.addEventListener("touchmove", adjustSidebarHeight, { passive: true });
      window.addEventListener("touchend", adjustSidebarHeight);
    </script>

    <script src="script.js"></script>
  </body>
</html>